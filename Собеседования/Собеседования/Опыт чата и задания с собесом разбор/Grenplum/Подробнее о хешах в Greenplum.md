**Хэширование** — это процесс преобразования значения (например, `customer_id = 101`) в числовое значение фиксированной длины с помощью математической функции. Greenplum использует хэширование для эффективного распределения данных между сегментами.

### **Почему Greenplum использует хэширование?**

1. **Равномерное распределение данных**:
    
    - Значения, такие как `customer_id`, могут быть неравномерно распределены (например, в базе много клиентов из одного региона).
    - Хэш-функция преобразует значения в псевдослучайные числа, что помогает равномерно распределить данные по сегментам.
2. **Универсальность**:
    
    - Использование хэш-функции позволяет Greenplum работать с любыми типами данных (`INT`, `VARCHAR`, `UUID` и т. д.).
    - Независимо от исходного значения, хэширование приводит к одному и тому же результату для одного и того же значения.
3. **Определённость**:
    
    - Для одного значения ключа всегда будет вычисляться одно и то же хэш-значение. Это гарантирует, что при одинаковых условиях данные с одним и тем же ключом окажутся на одном и том же сегменте.
4. **Эффективность поиска и доступа**:
    
    - Если Greenplum знает хэш-функцию, он может быстро определить, на каком сегменте хранятся данные, без необходимости опрашивать все сегменты.

Хеш делится по модулу количества сегментов ,для определения куда положить данные

### **Как хэширование работает в Greenplum?**

1. **Входное значение**: Например, `customer_id = 101`.
    
2. **Применение хэш-функции**: Greenplum применяет к значению математическую функцию, которая возвращает числовое значение (например, `hash(101) = 134251`).
    
3. **Определение сегмента**:
    
    - Хэш-значение делится по модулю на количество сегментов (`hash_value % num_segments`).
    - Результат определяет, на какой сегмент отправить данные.
    
    Пример: Если `hash(101) = 134251` и у нас 4 сегмента:

    `134251 % 4 = 3`
    
    Данные с `customer_id = 101` будут отправлены на сегмент 3.

### **Влияние хэширования на скорость**

1. **Преимущества хэширования**:
    
    - Быстрая идентификация сегмента (хэш-вычисления занимают миллисекунды).
    - Равномерное распределение данных снижает нагрузку на сегменты.
    - Ускорение выполнения `JOIN`, `GROUP BY`, и других операций, так как связанные данные оказываются на одном сегменте.
2. **Затраты на хэширование**:
    
    - Хэширование само по себе требует вычислительных ресурсов, но его стоимость незначительна по сравнению с выигрышем в равномерном распределении данных.
### **Итог**

Хэширование в Greenplum:

- Обеспечивает равномерное распределение данных независимо от исходного значения.
- Позволяет масштабировать систему без необходимости полной переразметки данных.
- Ускоряет доступ и операции с данными.

Использовать исходные значения для распределения возможно, но только в очень ограниченных случаях, когда значения равномерно распределены, заранее известны и не изменяются. Хэширование — универсальное и эффективное решение для работы с большими объёмами данных в MPP-архитектуре.



### **1. Что делать, если уникальных значений меньше, чем сегментов?**

Если количество уникальных значений в ключе дистрибуции меньше, чем сегментов, возникает проблема: не все сегменты будут использоваться, а это ведёт к дисбалансу нагрузки. Например, при 4 уникальных значениях и 8 сегментах половина сегментов останется пустой.

#### **Как это решается?**

1. **Перераспределение вручную**:
    
    - Если уникальных значений слишком мало (например, 4 значения для 8 сегментов), можно перераспределить данные, добавив дополнительные столбцы в ключ дистрибуции, чтобы повысить кардинальность.
    - Пример: Вместо `region_id` в качестве ключа дистрибуции можно использовать комбинацию столбцов:
        `DISTRIBUTED BY (region_id, sale_id);`
        
2. **Использование другого типа распределения**:
    
    - В случаях, когда количество уникальных значений слишком мало, можно использовать `RANDOM` для распределения данных. Это не идеальное решение, но оно позволяет задействовать все сегменты.
3. **Добавление искусственных значений**:
    
    - Если уникальных значений критически мало, можно добавить столбец с псевдослучайными числами в диапазоне, соответствующем количеству сегментов:
        `DISTRIBUTED BY (MOD(order_id, 8));`

### **2. Что происходит при увеличении числа сегментов, если уникальных значений много?**

Если уникальных значений в ключе дистрибуции значительно больше, чем сегментов (например, миллионы уникальных значений и десятки сегментов), система легко справляется с перераспределением данных:

1. **Автоматическая перераспределение данных**:
    
    - Когда количество сегментов увеличивается, Greenplum перераспределяет данные, основываясь на хэш-функции.
    - Хэш-значения автоматически адаптируются к новому числу сегментов (путём деления хэша на новое количество сегментов: `hash_value % new_num_segments`).
    - Это гарантирует, что данные распределяются равномерно между всеми новыми сегментами.
2. **Масштабируемость без полного перераспределения**:
    
    - Система не пересчитывает хэш-функции для всех данных — она адаптирует распределение только для тех строк, которые попадают на новые сегменты.
    - Например, если сегментов было 4 и добавили ещё 4, система перераспределит только те строки, которые "остались бы" на новых сегментах.


### **Пример увеличения сегментов**

#### Исходные условия:

- 1 миллион уникальных значений (`user_id`) и 4 сегмента.
- Хэш-распределение:
    `hash_value % 4`
    
#### Увеличение до 8 сегментов:

- Новая формула:
    `hash_value % 8`
    
#### Распределение данных:

- Сегменты 0, 1, 2, 3 останутся со своими данными.
- Данные, которые соответствуют новым сегментам (4, 5, 6, 7), будут перераспределены из сегментов 0–3.
#### Итог:

- Распределение данных автоматически адаптируется к увеличению сегментов, минимизируя нагрузку на администратора и затраты на перераспределение.


### **Ключевые моменты**

- Если уникальных значений меньше сегментов, возникает дисбаланс нагрузки. Это решается увеличением кардинальности ключа дистрибуции или использованием `RANDOM`.
- Если уникальных значений достаточно, увеличение сегментов автоматически перераспределяет часть нагрузки между новыми сегментами.
- **Высокая кардинальность** — ключевой фактор, обеспечивающий гибкость и масштабируемость системы без ручных вмешательств.