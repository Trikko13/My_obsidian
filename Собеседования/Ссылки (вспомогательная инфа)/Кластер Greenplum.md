Кластер Greenplum состоит из:

- _master node_ («мастер-ноды» или «главного узла») — конечные пользователи подключаются к нему для выполнения запроса;
    
- _standby node_ («резервного узла») — он обеспечивает поддержку доступности для мастера;
    
- _segment nodes_ («узлов сегментов») — являются рабочими узлами, где находятся данные.
    

Мастер-нода получает запрос, инициированный пользователем, выполняет его компиляцию и оптимизацию, генерирует план параллельного запроса и распределяет его по узлу сегмента. После выполнения данные отправляются обратно на главный узел и, наконец, передаются пользователю.

### Основные компоненты кластера Greenplum:

1. **Master Node (Мастер-узел)**:
    
    - Управляющий узел, который координирует выполнение всех запросов.
    - Клиенты подключаются именно к нему и отправляют SQL-запросы.
    - Мастер-узел отвечает за планирование и распределение выполнения запросов на сегменты, а также за сбор результатов с них.
2. **Segment Nodes (Сегментные узлы)**:
    
    - Это рабочие узлы, которые хранят данные и выполняют запросы.
    - Данные в Greenplum распределены между сегментами, и каждый сегмент отвечает за свою часть данных.
    - Запросы обрабатываются параллельно на каждом сегменте, что позволяет системе быстро выполнять сложные аналитические запросы.
3. **Interconnect (Система обмена данными)**:
    
    - Это высокоскоростная сеть, которая связывает мастер и сегментные узлы, а также сами сегменты между собой.
    - Она позволяет передавать данные между узлами, когда это необходимо для выполнения запросов.

### Как работает кластер Greenplum?

Когда приходит запрос:

- **Мастер-узел** разбивает его на несколько частей и отправляет на сегменты.
- **Сегменты** выполняют каждую часть запроса параллельно, работая только со своей частью данных.
- **Interconnect** связывает узлы и передает данные между ними, если сегментам нужно обменяться результатами или объединить данные.

Таким образом, кластер Greenplum — это вся система, которая включает мастер-узел, множество сегментов и межузловую сеть. Вместе эти компоненты образуют мощную инфраструктуру для выполнения аналитических запросов на больших данных.

### Пример: Как мастер-узел агрегирует данные от сегментов

Рассмотрим простой пример, чтобы понять этот процесс.
#### Задача:

Допустим, у нас есть таблица `sales` с продажами по разным регионам, распределённая между сегментами на основании столбца `region_id`. Мы хотим узнать общую сумму продаж по всем регионам.

#### Шаги выполнения запроса:

1. **Запрос от клиента**: Клиент посылает SQL-запрос на мастер-узел:
    `SELECT SUM(amount) FROM sales;`
    **Разделение запроса на части**:
    
    - Мастер-узел анализирует запрос и понимает, что таблица `sales` распределена по сегментам.
    - Он разбивает запрос так, чтобы каждый сегмент выполнял часть задачи параллельно.
2. **Промежуточные агрегации на сегментах**:
    
    - На каждом сегменте выполняется частичная агрегация, считая сумму продаж только для тех записей, которые находятся на этом сегменте:
        
        `SELECT SUM(amount) FROM sales;`
        
    - Каждый сегмент вычисляет промежуточную сумму `amount` и отправляет её обратно на мастер-узел.
3. **Финальная агрегация на мастер-узле**:
    
    - Мастер-узел получает частичные суммы от всех сегментов и выполняет финальную агрегацию:
        `SELECT SUM(partial_sum_from_segment1 + partial_sum_from_segment2 + ...);`
        
    - В результате он суммирует все промежуточные суммы и возвращает клиенту готовый ответ с общей суммой продаж.
### Итог
Мастер-узел в Greenplum действует как координирующий центр:
- Он направляет сегменты на выполнение промежуточных операций.
- Выполняет финальные расчёты (в нашем случае — суммирование промежуточных сумм).
- Возвращает клиенту окончательный результат.

Этот подход позволяет значительно ускорить выполнение запросов за счёт параллельной обработки, так как каждый сегмент выполняет свою часть работы.