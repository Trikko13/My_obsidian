# **–ö–æ–¥ ETL-–ø–∞–π–ø–ª–∞–π–Ω–∞: HDFS ‚Üí Spark ‚Üí Greenplum**

## **üîπ 1. –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ HDFS –≤ Spark**

from pyspark.sql import SparkSession

–°–æ–∑–¥–∞—ë–º Spark-—Å–µ—Å—Å–∏—é
spark SparkSession.builder.appName("ETL_HDFS_to_GP").getOrCreate()

–ß–∏—Ç–∞–µ–º CSV-—Ñ–∞–π–ª –∏–∑ HDFS
df = spark.read.option("header", "true").csv("hdfs://namenode:9000/data/sales.csv")

df.show(5)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 5 —Å—Ç—Ä–æ–∫


‚úÖ **–ü–æ—á–µ–º—É Spark?**

- –û–Ω —É–º–µ–µ—Ç **—Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ —á–∏—Ç–∞—Ç—å –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –±–æ–ª—å—à–∏–µ —Ñ–∞–π–ª—ã** –≤ HDFS
- –û–Ω –º–æ–∂–µ—Ç –ª–µ–≥–∫–æ **–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å CSV, JSON, Parquet**

---

## **üîπ 2. –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ Spark**

python

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å

`from pyspark.sql.functions import col, sum  # –§–∏–ª—å—Ç—Ä—É–µ–º –ø—Ä–æ–¥–∞–∂–∏ —Ç–æ–ª—å–∫–æ –∑–∞ 2024 –≥–æ–¥ df = df.filter(col("sale_date") >= "2024-01-01")  # –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –ø—Ä–æ–¥–∞–∂–∏ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º df_agg = df.groupBy("product_id").agg(sum("amount").alias("total_sales"))  df_agg.show(5)  # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç`

‚úÖ **–ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?**

- –§–∏–ª—å—Ç—Ä—É–µ–º **—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** (`sale_date >= "2024-01-01"`)
- –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º **–ø—Ä–æ–¥–∞–∂–∏ –ø–æ –ø—Ä–æ–¥—É–∫—Ç–∞–º** (`SUM(amount) GROUP BY product_id`)

---

## **üîπ 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª (–¥–ª—è Greenplum `COPY`)**

python

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å

`output_path = "/tmp/sales_transformed.csv" df_agg.coalesce(1).write.option("header", "true").csv(output_path, mode="overwrite")`

‚úÖ **–ó–∞—á–µ–º `coalesce(1)`?**

- Spark **–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–∏—à–µ—Ç –º–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤** (–ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–∞—Ä—Ç–∏—Ü–∏–π).
- `coalesce(1)` **–æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å—ë –≤ 1 CSV-—Ñ–∞–π–ª** (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è `COPY`).

---

## **üîπ 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Greenplum (`COPY`)**

bash

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å

`psql -h gp_host -U gp_user -d gp_database -c "     COPY sales_aggregated FROM '/tmp/sales_transformed.csv'     WITH CSV HEADER;"`

‚úÖ **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `COPY`?**

- –ï—Å–ª–∏ **—Ñ–∞–π–ª —É–∂–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å Greenplum**.
- `COPY` **–±—ã—Å—Ç—Ä–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ** (–Ω–∞–º–Ω–æ–≥–æ –±—ã—Å—Ç—Ä–µ–µ `INSERT`).

---

## **üîπ 5. –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥: `gpload` (–µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞ —É–¥–∞–ª—ë–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ)**

### **üìú –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è YAML-—Ñ–∞–π–ª–∞ –¥–ª—è `gpload`**

yaml

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å

`VERSION: 1.0.0.1 DATABASE: gp_database USER: gp_user HOST: gp_host PORT: 5432 TABLE: sales_aggregated MODE: INSERT FORMAT: CSV DELIMITER: ',' ERROR_LIMIT: 100 EXTERNAL: true LOGFILE: /tmp/gpload.log`

### **–ó–∞–ø—É—Å–∫–∞–µ–º `gpload`**

bash

–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å

`gpload -f gpload_config.yml`

‚úÖ **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `gpload`?**

- –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è **–Ω–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Greenplum**.
- –ï—Å–ª–∏ –Ω—É–∂–Ω–æ **–º–∞—Å—Å–æ–≤–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –±–æ–ª—å—à–∏–µ –æ–±—ä—ë–º—ã –¥–∞–Ω–Ω—ã—Ö**.
- `gpload` **–±—ã—Å—Ç—Ä–µ–µ, —á–µ–º `INSERT`, –∏ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ, —á–µ–º `COPY` –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö**.