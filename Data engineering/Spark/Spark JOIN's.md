1. Sort Merge Join
2. Shuffle Hash Join
3. Broadcast Hash Join
4. Cartesian Join
5. Broadcasted Nested Loop Join


**1. Broadcast Hash Join (BHJ)** — Самый простой и быстрый для малых таблиц
### **Описание:**
- Один из входных DataFrame или RDD (малая таблица) **полностью передается на все узлы** кластера.
- На каждом узле выполняется **локальный hash join** между копией малой таблицы и частями большой таблицы.
### **Когда использовать:**
- Когда **одна из таблиц маленькая** (обычно ≤ 2 ГБ).
- Это помогает избежать дорогого **shuffle**.

`from pyspark.sql import SparkSession
`from pyspark.sql.functions import broadcast

`spark = SparkSession.builder.appName("BroadcastJoin").getOrCreate()

`Создаем малую таблицу
`small_df = spark.createDataFrame(
  `  [(1, "Alice"), (2, "Bob")], ["id", "name"]
)

`Создаем большую таблицу
`large_df = spark.createDataFrame(
  `  [(1, "HR"), (2, "IT"), (3, "Finance")], ["id", "department"]
)

`Выполняем Broadcast Join
`result = large_df.join(broadcast(small_df), "id")
`result.show()

small_df = spar.createDataFrame(
	[(1, 'Alice), (2, 'Bob')], ['id', 'name']
)

### **Важные комментарии для конспекта:**

1. **`broadcast`**: Явно указывает Spark передать малую таблицу на все узлы.
2. **Преимущества**:
    - Нет shuffle (данные не перемещаются между узлами).
    - Быстро выполняется на узлах, так как join выполняется локально.
3. **Недостатки**:
    - Работает **только с малыми таблицами**.
    - Расходуется память на хранение копий таблицы на всех узлах.

## **2. Shuffle Hash Join (SHJ)** — Для больших таблиц, если их можно хэшировать

### **Описание:**

- Обе таблицы **разбиваются (shuffle)** между узлами на основе ключей.
- На каждом узле выполняется **hash join** между соответствующими партициями.

### **Когда использовать:**

- Когда **обе таблицы большие** и их можно разбить на партиции на основе ключа.
`#Создаем две большие таблицы
`df1 = spark.createDataFrame(
  ``  [(1, "Alice"), (2, "Bob"), (3, "John")], ["id", "name"]
`)

`df2 = spark.createDataFrame(
  ``  [(1, "HR"), (2, "IT"), (3, "Finance")], ["id", "department"]
)

`#Shuffle Hash Join выполняется по умолчанию, если таблицы большие
`result = df1.join(df2, "id")
`result.show()

### **Важные комментарии для конспекта:**

1. **Shuffle:** Обе таблицы шардируются на основе ключа.
2. **Преимущества**:
    - Работает с большими таблицами.
3. **Недостатки**:
    - **Shuffle — дорогая операция**, так как данные перемещаются между узлами.
    - Требует больше памяти для построения хэш-таблицы.


## **3. Sort Merge Join (SMJ)** — Стандартный для больших таблиц

### **Описание:**

- Обе таблицы сортируются по ключам и **сливаются** (merge) на основе ключа.
- Используется, когда **таблицы слишком большие для хэширования**.

### **Когда использовать:**

- Когда обе таблицы **большие**, а ключи можно отсортировать.
`#Пример Sort Merge Join (это выполняется автоматически для больших таблиц)
`result = df1.join(df2, "id", "inner")  # Inner join
`result.show()

### **Важные комментарии для конспекта:**

1. **Сортировка:** Обе таблицы сортируются перед объединением.
2. **Преимущества**:
    - Работает с **очень большими таблицами**.
    - Не требует хэширования.
3. **Недостатки**:
    - Сортировка — дорогая операция.
    - Требуется shuffle.

## **4. Broadcast Nested Loop Join (BNLJ)** — Для ситуаций, когда нет ключей

### **Описание:**

- Полный **перебор всех строк** малой таблицы и большой таблицы.
- Выполняется, если **нет ключей** для join.

### **Когда использовать:**

- Когда join **выполняется без условий (CROSS JOIN)**.
- Когда нет общих ключей.

`Выполняем Cartesian Join (все комбинации строк)
`result = small_df.crossJoin(large_df)
`result.show()

.### **Важные комментарии для конспекта:**

1. **Полный перебор**: Все строки сопоставляются.
2. **Преимущества**:
    - Работает в случае **отсутствия ключей**.
3. **Недостатки**:
    - Очень **медленный** на больших данных.

**5. Cartesian Join** — Полный декартов продукт
### **Описание:**

- Это специальный случай **Broadcast Nested Loop Join**, когда выполняется полный **декартов продукт**.
- Все строки одной таблицы соединяются со всеми строками другой таблицы.
### **Когда использовать:**

- Редко используется на практике из-за **взрывного роста данных**.

## **Как выбрать тип join?**

| Тип Join                       | Когда использовать                    | Преимущества                  | Недостатки                           |
| ------------------------------ | ------------------------------------- | ----------------------------- | ------------------------------------ |
| **Broadcast Hash Join**        | Маленькая таблица + большая таблица   | Быстрый, без shuffle          | Ограничение по размеру малой таблицы |
| **Shuffle Hash Join**          | Обе таблицы большие и хэшируемые      | Работает с большими таблицами | Shuffle — дорогая операция           |
| **Sort Merge Join**            | Обе таблицы большие                   | Эффективно на больших данных  | Требует сортировки и shuffle         |
| **Broadcast Nested Loop Join** | Нет ключей или специфичный cross join | Работает без условий          | Очень медленный                      |
| **Cartesian Join**             | Полный декартов продукт               | Простой в реализации          | Взрывной рост данных                 |


### **Сравнение: Shuffle Hash Join vs Sort Merge Join**

| **Критерий**            | **Shuffle Hash Join**                               | **Sort Merge Join**                    |
| ----------------------- | --------------------------------------------------- | -------------------------------------- |
| **Как работает**        | Строит хэш-таблицу для одной из таблиц.             | Сортирует обе таблицы и сливает их.    |
| **Требования к памяти** | Нужна **достаточная память** для хэш-таблицы.       | Менее чувствителен к памяти.           |
| **Производительность**  | Быстрее, если таблицы **вмещаются в память**.       | Медленнее из-за **сортировки** данных. |
| **Объём данных**        | Работает с **большими**, но хэшируемыми данными.    | Подходит для **очень больших таблиц**. |
| **Shuffle**             | Есть shuffle.                                       | Есть shuffle + сортировка.             |
| **Когда использовать**  | Когда таблицы **умеренного размера** и равномерные. | Когда таблицы **очень большие**.       |
