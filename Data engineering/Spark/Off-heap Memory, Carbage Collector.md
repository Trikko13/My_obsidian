**Off-Heap memory** в Spark — это память, которая выделяется **за пределами управления JVM (Java Virtual Machine)**. Обычно Spark использует память JVM (Heap memory) для вычислений и хранения данных, но Off-Heap memory позволяет:

1. **Снизить нагрузку на сборщик мусора (Garbage Collector, GC):**
    
    - Spark не управляет памятью Off-Heap через JVM, поэтому сборщик мусора не занимается её очисткой.
    - Это может улучшить производительность, особенно для задач, работающих с большими объёмами данных.
2. **Увеличить объём доступной памяти:**
    
    - Off-Heap memory может быть использована для кэширования данных или работы с большими наборами данных, выходящими за рамки ограничений Heap.

---

#### **Как включить Off-Heap memory?**

В Spark Off-Heap memory используется для хранения данных через **Tungsten Execution Engine**, который управляет памятью напрямую.

1. Настройка параметров:
    
    bash
    
    Копировать код
    
    `spark.memory.offHeap.enabled = true  # Включить использование Off-Heap spark.memory.offHeap.size = 512m    # Размер Off-Heap памяти`
    
2. Применение:
    
    - Используется для кэширования RDD или DataFrame.
    - Улучшает производительность для операций shuffle, join, sort.

---

#### **Пример использования:**

- Когда задачи shuffle перегружают JVM и приводят к частым паузам на сборку мусора, Off-Heap memory помогает избежать этих проблем.
- Если данные слишком велики для Heap, они могут быть сохранены в Off-Heap.

### **Почему сборщик мусора (Garbage Collector) может быть проблемой?**

**Сборщик мусора** управляет памятью JVM (Heap memory) и периодически освобождает её, очищая объекты, которые больше не используются. Однако в больших системах, таких как Spark, GC может стать узким местом:

1. **Большой объём объектов в памяти:**
    
    - Spark часто создаёт много временных объектов (например, промежуточные результаты вычислений, shuffle-данные).
    - GC вынужден просматривать всю память, что увеличивает задержки, особенно при больших объёмах данных.
2. **Паузы GC (Stop-The-World):**
    
    - Когда JVM запускает GC, выполнение всех задач останавливается, пока память не будет очищена.
    - Это может быть критично для задач, работающих с гигабайтами данных.
3. **Высокая нагрузка на GC при shuffle:**
    
    - Shuffle операции требуют создания множества временных объектов в памяти, которые быстро становятся "мусором".

Аналогия по устройству схемы [[память.png]]

#### **Executor = Мини-завод**

- Представь, что каждый **Executor** — это маленький завод:
    - **Heap Memory** (On-Heap) — это основной рабочий зал завода.
        - **Execution Memory**: место, где рабочие делают расчёты (shuffle, join).
        - **Storage Memory**: место, где складируются материалы (RDD, DataFrame).
    - **Off-Heap Memory**: отдельный склад за пределами завода, куда можно убирать что-то тяжёлое, чтобы освободить рабочий зал.
    - **Overhead Memory**: это подсобка для обслуживающего персонала (shuffle, система, Python).

#### **Disk Spill = Склад на улице**

- Если на заводе всё переполнено (Heap + Off-Heap), материалы временно отправляются на уличный склад (**Disk Spill**).
- Это долго и дорого, но позволяет заводу продолжать работу.

### **Отличия Off-Heap и On-Heap:**

| Характеристика              | On-Heap Memory                 | Off-Heap Memory                                                    |
| --------------------------- | ------------------------------ | ------------------------------------------------------------------ |
| **Расположение**            | Внутри JVM                     | Вне JVM (системная нативная память)                                |
| **Управление памятью**      | Java Garbage Collector         | Управляется вручную (через Spark)                                  |
| **Эффективность GC**        | GC может вызывать паузы        | Отсутствие влияния GC                                              |
| **Необходимость настройки** | Настраивается по умолчанию     | Требует явного включения                                           |
| **Параметры конфигурации**  | `spark.executor.memory`        | `spark.memory.offHeap.enabled=true`, `spark.memory.offHeap.size`   |
| **Область применения**      | Подходит для большинства задач | Используется для тяжёлых вычислений, чтобы избежать нагрузки на GC |
