Отличный вопрос! `FILTER`, `WHERE` и `HAVING` действительно похожи, но у каждого оператора своя задача и области применения. Давай разберём, чем они отличаются и когда каждый из них полезен.

### 1. **`FILTER` в агрегирующих функциях**

`FILTER` используется **внутри агрегирующих функций**, чтобы применить условия к конкретным значениям в рамках самой функции. Это полезно, когда:
- **Условие применяется только к агрегирующей функции** и не нужно влиять на остальные строки запроса.
- Хочется добавить логику, которая не потребует дополнительных подзапросов.

#### Пример
```sql
SELECT order_id,
       array_agg(name) FILTER (WHERE name IS NOT NULL) AS product_names
FROM orders
LEFT JOIN products ON orders.product_id = products.product_id
GROUP BY order_id;
```

- **Когда использовать `FILTER`**: 
  - Когда нужно применить условие только к агрегируемым данным, не влияя на общую выборку строк.
  - Например, собрать массив `name` только для ненулевых значений, не исключая сами строки из результата.

### 2. **`WHERE` — фильтрация строк на уровне всей таблицы**

`WHERE` фильтрует строки **до того, как выполняются агрегирующие функции**. Он исключает строки на уровне таблицы или подзапроса и является наиболее используемым оператором фильтрации.
- **Когда использовать `WHERE`**: 
  - Когда нужно исключить строки из выборки на этапе исходных данных.
  - Применяется к отдельным строкам таблицы до группировки и агрегирования.

#### Пример
```sql
SELECT order_id, array_agg(product_id) AS product_ids
FROM orders
WHERE status = 'delivered'  -- исключает недоставленные заказы на уровне строк
GROUP BY order_id;
```

### 3. **`HAVING` — фильтрация агрегированных результатов**

`HAVING` используется **после группировки данных с `GROUP BY`**. Это фильтр, который применяется к **агрегированным данным**, то есть `HAVING` позволяет фильтровать группы строк на основе результата агрегирующих функций.
- **Когда использовать `HAVING`**:
  - Когда нужно отфильтровать группы после применения агрегатных функций.
  - Полезен для условий, основанных на результатах агрегирования (например, минимальное количество, среднее значение и т.д.).

#### Пример
```sql
SELECT customer_id, COUNT(order_id) AS total_orders
FROM orders
GROUP BY customer_id
HAVING COUNT(order_id) > 5;  -- отбирает только тех клиентов, у кого больше 5 заказов
```

### Сводка — когда использовать `FILTER`, `WHERE`, `HAVING`

| Оператор | Когда применять                                                                                   | Пример применения                                             |
|----------|---------------------------------------------------------------------------------------------------|---------------------------------------------------------------|
| `FILTER` | Чтобы применить условие к агрегирующей функции **внутри `SELECT`**.                               | `array_agg(product_id) FILTER (WHERE product_id IS NOT NULL)` |
| `WHERE`  | Чтобы отфильтровать строки **до агрегирования и группировки**.                                    | `WHERE status = 'delivered'`                                  |
| `HAVING` | Чтобы фильтровать **после агрегирования** и **группировки** на уровне групп.                      | `HAVING COUNT(order_id) > 5`                                  |

Таким образом:
- Используй **`FILTER` внутри агрегирующих функций** для специфической фильтрации в функции.
- Применяй **`WHERE` для фильтрации исходных данных** перед выполнением любых агрегатов или группировки.
- **`HAVING` удобен для фильтрации на уровне групп**, когда нужна фильтрация по агрегированным значениям.